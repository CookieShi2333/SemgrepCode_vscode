rules:
  - id: tainted-ssrf-spring-add
    message: Untrusted input might be used to build an HTTP request, which can lead to a Server-side request forgery (SSRF) vulnerability. SSRF allows an attacker to send crafted requests from the server side to other internal or external systems. SSRF can lead to unauthorized access to sensitive data and, in some cases, allow the attacker to control applications or systems that trust the vulnerable service. To prevent this vulnerability, avoid allowing user input to craft the base request. Instead, treat it as part of the path or query parameter and encode it appropriately. When user input is necessary to prepare the HTTP request, perform strict input validation. Additionally, whenever possible, use allowlists to only interact with expected, trusted domains.
    severity: ERROR
    metadata:
      likelihood: MEDIUM
      impact: HIGH
      confidence: HIGH
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-918: Server-Side Request Forgery (SSRF)"
      cwe2021-top25: true
      cwe2022-top25: true
      display-name: Server-Side Request Forgery (SSRF) with Spring
      functional-categories:
        - net::sink::http-request::ApacheHttpClient
        - net::sink::http-request::Guava
        - net::sink::http-request::HttpClient
        - net::sink::http-request::Jsoup
        - net::sink::http-request::OkHttp
        - net::sink::http-request::RestTemplate
        - net::sink::http-request::URL
        - net::sink::http-request::WebClient
        - web::source::cookie::Spring
        - web::source::header::Spring
        - web::source::http-body::Spring
        - web::source::url-path-params::Spring
        - web::source::url-query-string::Spring
      owasp:
        - A01:2025 - Broken Access Control
        - A10:2021 - Server-Side Request Forgery (SSRF)
      references:
        - https://owasp.org/Top10/2025/A01_2025-Broken_Access_Control/
        - https://owasp.org/Top10/A10_2021-Server-Side_Request_Forgery_%28SSRF%29
      supersedes:
        - java.servlets.security.tainted-ssrf-deepsemgrep-add.tainted-ssrf-deepsemgrep-add
      technology:
        - Spring
        - java
      license: Semgrep Rules License v1.0. For more details, visit semgrep.dev/legal/rules-license
      vulnerability_class:
        - Server-Side Request Forgery (SSRF)
    languages:
      - java
    mode: taint
    options:
      interfile: true
      taint_assume_safe_booleans: true
      taint_assume_safe_numbers: true
    pattern-sources:
      - label: REQ
        patterns:
          - pattern-either:
              - pattern: $RET $METHOD(..., @$REQ(...) $TYPE $SOURCE, ...) {...}
              - pattern: $RET $METHOD(..., @$REQ $TYPE $SOURCE, ...) {...}
          - metavariable-regex:
              metavariable: $REQ
              regex: (RequestBody|PathVariable|RequestParam|RequestHeader|CookieValue|ModelAttribute|MatrixVariable|RequestPart|RequestAttribute)
          - focus-metavariable: $SOURCE
      - label: REQ
        patterns:
          - pattern-either:
              - pattern-inside: |
                  @$MAPPING(...)
                  $RET $METHODNAME(..., $TYPE $SOURCE, ...) {...}
              - pattern-inside: |
                  @$MAPPING
                  $RET $METHODNAME(..., $TYPE $SOURCE, ...) {...}
          - pattern-either:
              - pattern: $RET $METHOD(..., String $SOURCE, ...) {...}
              - pattern: $RET $METHOD(..., org.springframework.http.HttpEntity<$X> $SOURCE, ...) {...}
              - pattern: $RET $METHOD(..., java.io.InputStream $SOURCE, ...) {...}
              - pattern: $RET $METHOD(..., java.io.Reader $SOURCE, ...) {...}
          - metavariable-regex:
              metavariable: $MAPPING
              regex: (ResponseBody|RequestMapping|PatchMapping|GetMapping|DeleteMapping|PutMapping|PostMapping|HttpExchange|GetExchange|PostExchange|PutExchange|PatchExchange|DeleteExchange|ResponseStatus)
          - focus-metavariable: $SOURCE
      - label: REQ
        patterns:
          - pattern-either:
              - pattern: (org.springframework.web.context.request.WebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.NativeWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.FacesWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.ServletWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.servlet.handler.DispatcherServletWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.async.AsyncWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.async.StandardServletAsyncWebRequest $REQ).$METHOD(...)
          - metavariable-regex:
              metavariable: $METHOD
              regex: (getHeader|getHeaderNames|getHeaderValues|getParameter|getParameterMap|getParameterNames|getParameterValues|getAttribute|getAttributeNames)
      - label: REQ
        patterns:
          - pattern-either:
              - pattern: (org.springframework.http.HttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.client.ClientHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.server.ServerHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.server.ServletServerHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.multipart.support.RequestPartServletServerHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.server.reactive.ServerHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.server.reactive.ServerHttpRequestDecorator $REQ).$METHOD(...)
          - metavariable-regex:
              metavariable: $METHOD
              regex: (getPath|getQueryParams|getBody|getURI|getHeaders|getCookies)
      - label: NOT_CONCAT
        patterns:
          - focus-metavariable: $X
          - pattern-either:
              - pattern: $F + $X
              - pattern: String.format(..., $X, ...)
              - pattern: MessageFormat.format(..., $X, ...)
          - pattern-not: $X + $F
          - pattern-not: |
              "https://" + $X
          - pattern-not: |
              "http://" + $X
          - pattern-not: |
              "ws://" + $X
          - pattern-not: |
              "wss://" + $X
          - pattern-not: |
              "//" + $X
        requires: REQ
    pattern-propagators:
      - from: $FROM
        patterns:
          - pattern-either:
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add($FROM)
                      - pattern: $TO.add($X, $FROM)
                      - pattern: $TO.addAll($FROM)
                      - pattern: $TO.addAll($X, $FROM)
                      - pattern: $TO.addFirst(..., $FROM, ...)
                      - pattern: $TO.addLast(..., $FROM, ...)
                      - pattern: $TO.addAllAbsent(..., $FROM, ...)
                      - pattern: $TO.addIfAbsent(..., $FROM, ...)
                      - pattern: $TO.addElement(..., $FROM, ...)
                      - pattern: $TO.set($X, $FROM)
                      - pattern: $TO.push(..., $FROM, ...)
                      - pattern: $TO.setElementAt(..., $FROM, ...)
                      - pattern: $TO.replaceAll(..., $FROM, ...)
                      - pattern: $TO.insertElementAt($FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.List
                        - java.util.List<$_>
                        - java.util.Stack
                        - java.util.Stack<$_>
                        - java.util.Vector
                        - java.util.Vector<$_>
                        - java.util.ArrayList
                        - java.util.ArrayList<$_>
                        - java.util.LinkedList
                        - java.util.LinkedList<$_>
                        - java.util.AbstractList
                        - java.util.AbstractList<$_>
                        - java.util.AbstractSequentialList
                        - java.util.AbstractSequentialList<$_>
                        - java.util.concurrent.CopyOnWriteArrayList
                        - java.util.concurrent.CopyOnWriteArrayList<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add(..., $FROM, ...)
                      - pattern: $TO.addFirst(..., $FROM, ...)
                      - pattern: $TO.addLast(..., $FROM, ...)
                      - pattern: $TO.addAll(..., $FROM, ...)
                      - pattern: $TO.put(..., $FROM, ...)
                      - pattern: $TO.putLast(..., $FROM, ...)
                      - pattern: $TO.putFirst(..., $FROM, ...)
                      - pattern: $TO.push(..., $FROM, ...)
                      - pattern: $TO.offer($FROM, ...)
                      - pattern: $TO.offerLast($FROM, ...)
                      - pattern: $TO.offerFirst($FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Queue
                        - java.util.Queue<$_>
                        - java.util.Deque
                        - java.util.Deque<$_>
                        - java.util.ArrayDeque
                        - java.util.ArrayDeque<$_>
                        - java.util.AbstractQueue
                        - java.util.AbstractQueue<$_>
                        - java.util.concurrent.DelayQueue
                        - java.util.concurrent.DelayQueue<$_>
                        - java.util.concurrent.BlockingQueue
                        - java.util.concurrent.BlockingQueue<$_>
                        - java.util.concurrent.TransferQueue
                        - java.util.concurrent.TransferQueue<$_>
                        - java.util.concurrent.BlockingDeque
                        - java.util.concurrent.BlockingDeque<$_>
                        - java.util.concurrent.SynchronousQueue
                        - java.util.concurrent.SynchronousQueue<$_>
                        - java.util.concurrent.LinkedTransferQueue
                        - java.util.concurrent.LinkedTransferQueue<$_>
                        - java.util.concurrent.ArrayBlockingQueue
                        - java.util.concurrent.ArrayBlockingQueue<$_>
                        - java.util.concurrent.LinkedBlockingDeque
                        - java.util.concurrent.LinkedBlockingDeque<$_>
                        - java.util.concurrent.LinkedBlockingQueue
                        - java.util.concurrent.LinkedBlockingQueue<$_>
                        - java.util.concurrent.PriorityBlockingQueue
                        - java.util.concurrent.PriorityBlockingQueue<$_>
                        - java.util.concurrent.ConcurrentLinkedDeque
                        - java.util.concurrent.ConcurrentLinkedDeque<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add(..., $FROM, ...)
                      - pattern: $TO.addAll(..., $FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Set
                        - java.util.Set<$_>
                        - java.util.TreeSet
                        - java.util.TreeSet<$_>
                        - java.util.EnumSet
                        - java.util.EnumSet<$_>
                        - java.util.HashSet
                        - java.util.HashSet<$_>
                        - java.util.SortedSet
                        - java.util.SortedSet<$_>
                        - java.util.AbstractSet
                        - java.util.AbstractSet<$_>
                        - java.util.NavigableSet
                        - java.util.NavigableSet<$_>
                        - java.util.LinkedHashSet
                        - java.util.LinkedHashSet<$_>
                        - java.util.AbstractCollection
                        - java.util.AbstractCollection<$_>
                        - java.util.concurrent.CopyOnWriteArraySet
                        - java.util.concurrent.CopyOnWriteArraySet<$_>
                        - java.util.concurrent.ConcurrentSkipListSet
                        - java.util.concurrent.ConcurrentSkipListSet<$_>
                        - java.util.concurrent.ConcurrentHashMap.KeySetView
                        - java.util.concurrent.ConcurrentHashMap.KeySetView<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.merge(..., $FROM, ...)
                      - pattern: $TO.put(..., $FROM, ...)
                      - pattern: $TO.putAll(..., $FROM, ...)
                      - pattern: $TO.putIfAbsent(..., $FROM, ...)
                      - pattern: $TO.replace($X, ..., $FROM, ...)
                      - pattern: $TO.replaceAll(..., $FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Map
                        - java.util.Map<$_, $_>
                        - java.util.NavigableMap
                        - java.util.NavigableMap<$_, $_>
                        - java.util.SortedMap
                        - java.util.SortedMap<$_, $_>
                        - java.util.TreeMap
                        - java.util.TreeMap<$_, $_>
                        - java.util.AbstractMap
                        - java.util.AbstractMap<$_, $_>
                        - java.util.EnumMap
                        - java.util.EnumMap<$_, $_>
                        - java.util.HashMap
                        - java.util.HashMap<$_, $_>
                        - java.util.Hashtable
                        - java.util.Hashtable<$_, $_>
                        - java.util.IdentityHashMap
                        - java.util.IdentityHashMap<$_, $_>
                        - java.util.LinkedHashMap
                        - java.util.LinkedHashMap<$_, $_>
                        - java.util.WeakHashMap
                        - java.util.WeakHashMap<$_, $_>
                        - java.util.concurrent.ConcurrentMap
                        - java.util.concurrent.ConcurrentMap<$_, $_>
                        - java.util.concurrent.ConcurrentHashMap
                        - java.util.concurrent.ConcurrentHashMap<$_, $_>
                        - java.util.concurrent.ConcurrentSkipListMap
                        - java.util.concurrent.ConcurrentSkipListMap<$_, $_>
                        - java.util.concurrent.ConcurrentNavigableMap
                        - java.util.concurrent.ConcurrentNavigableMap<$_, $_>
                        - java.util.Properties
                        - java.util.Properties<$_, $_>
        to: $TO
      - from: $INPUT
        patterns:
          - pattern-either:
              - pattern: String.format($FMT, ..., $INPUT, ...)
              - pattern: MessageFormat.format($FMT, ..., $INPUT, ...)
        to: $FMT
      - from: $FROM
        patterns:
          - pattern-either:
              - pattern: (StringBuilder $TO).append($FROM, ...)
              - pattern: (StringBuilder $TO).insert($OFFSET, $FROM, ...)
              - pattern: (StringBuilder $TO).replace($START, $END, $FROM, ...)
              - pattern: (StringBuffer $TO).append($FROM, ...)
              - pattern: (StringBuffer $TO).insert($OFFSET, $FROM, ...)
        to: $TO
    pattern-sinks:
      - patterns:
          - focus-metavariable: $URI
          - pattern-either:
              - pattern: (java.net.http.HttpClient $CL). ... .send($URI, ...)
              - pattern: (java.net.http.HttpClient $CL). ... .sendAsync($URI, ...)
              - pattern: java.net.http.HttpClient. ... .send($URI, ...)
              - pattern: java.net.http.HttpClient. ... .sendAsync($URI, ...)
        requires: REQ and not NOT_CONCAT
      - patterns:
          - pattern: (java.net.URL $URL).$FUNC(...)
          - metavariable-regex:
              metavariable: $FUNC
              regex: ^(openConnection|openStream|getContent)$
        requires: REQ and not NOT_CONCAT
      - patterns:
          - focus-metavariable: $URI
          - pattern-either:
              - pattern: (org.springframework.web.client.RestTemplate $REST). ... .$RESTFUNC($URI, ...)
              - pattern: new org.springframework.web.client.RestTemplate(...). ... .$RESTFUNC($URI, ...)
          - metavariable-regex:
              metavariable: $RESTFUNC
              regex: ^(exchange|doExecute|execute|getForEntity|getForObject|patchForObject|postForEntity|postForLocation|postForObject|put)$
        requires: REQ and not NOT_CONCAT
      - patterns:
          - focus-metavariable: $URI
          - pattern-either:
              - pattern: org.springframework.web.reactive.function.client.WebClient. ... .$URIFUNC($URI)
              - pattern: (org.springframework.web.reactive.function.client.WebClient $CLIENT). ... .$URIFUNC($URI)
          - pattern-either:
              - pattern-inside: org.springframework.web.reactive.function.client.WebClient. ... .retrieve(...)
              - pattern-inside: (org.springframework.web.reactive.function.client.WebClient $CLIENT). ... .retrieve(...)
          - metavariable-regex:
              metavariable: $URIFUNC
              regex: ^(uri|baseUrl|create)$
        requires: REQ and not NOT_CONCAT
      - patterns:
          - focus-metavariable: $URI
          - pattern-either:
              - pattern: new okhttp3.Request.Builder(). ... .url($URI)
          - pattern-either:
              - pattern-inside: |
                  ...
                  $CLIENT.newCall(...).execute(...);
              - pattern-inside: |
                  $CALL = $CLIENT.newCall(...);
                  ...
                  $CALL.execute(...);
        requires: REQ and not NOT_CONCAT
      - patterns:
          - focus-metavariable: $URI
          - pattern-either:
              - pattern: org.jsoup.Jsoup.connect($URI)
          - pattern-either:
              - pattern-inside: $JSOUP.execute(...)
              - pattern-inside: $JSOUP.get(...)
              - pattern-inside: $JSOUP.post(...)
        requires: REQ and not NOT_CONCAT
      - patterns:
          - focus-metavariable: $URI
          - pattern-either:
              - pattern: org.apache.http.HttpRequest. ... .newBuilder($URI)
              - pattern: org.apache.http.HttpRequest. ... .uri($URI)
              - patterns:
                  - pattern: new org.apache.http.client.methods.$METHOD($URI, ...)
                  - metavariable-regex:
                      metavariable: $METHOD
                      regex: ^(HttpGet|HttpPost|HttpDelete|HttpDelete|HttpOptions|HttpPatch|HttpPut|HttpHead)$
          - pattern-either:
              - pattern-inside: |
                  ...
                  $CLIENT.send(...);
              - pattern-inside: |
                  ...
                  $CLIENT.execute(...);
        requires: REQ and not NOT_CONCAT
      - patterns:
          - focus-metavariable: $URI
          - pattern-either:
              - pattern: com.google.common.io.Resources.asCharSource($URI, ...)
              - pattern: com.google.common.io.Resources.asByteSource($URI, ...)
        requires: REQ and not NOT_CONCAT
    pattern-sanitizers:
      - pattern: (ChoiceFormat $X).format(...)
      - pattern: (DecimalFormat $X).format(...)
      - pattern: (java.util.UUID $X)
      - patterns:
          - focus-metavariable: $X
          - pattern: io.micronaut.http.HttpRequest.$METHOD($URL, ..., $X, ...)
      - patterns:
          - pattern: io.micronaut.http.uri.UriBuilder. ... .$FUNC(...)
          - metavariable-pattern:
              metavariable: $FUNC
              patterns:
                - pattern-either:
                    - pattern: path
                    - pattern: expand
                    - pattern: queryParam
      - patterns:
          - focus-metavariable: $X
          - pattern-either:
              - pattern: java.net.http.HttpRequest. ... .$FUNC(..., $X, ...)
              - pattern: (java.net.http.HttpRequest.Builder $B). ... .$FUNC(..., $X, ...)
          - metavariable-pattern:
              metavariable: $FUNC
              patterns:
                - pattern-not-regex: ^(newBuilder|uri)$
      - patterns:
          - focus-metavariable: $PARAM
          - pattern: $URLBUILDER. ... .addQueryParameter(..., $PARAM). ...
