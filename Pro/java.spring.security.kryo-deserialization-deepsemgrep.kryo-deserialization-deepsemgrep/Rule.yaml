rules:
  - id: kryo-deserialization-deepsemgrep
    message: 'The application may convert user-controlled data into an object, which can lead to an insecure deserialization vulnerability. An attacker can create a malicious serialized object, pass it to the application, and take advantage of the deserialization process to perform Denial-of-service (DoS), Remote code execution (RCE), or bypass access control measures. To prevent this vulnerability, leverage data formats such as JSON or XML as safer alternatives. If you need to deserialize user input in a specific format, consider digitally signing the data before serialization to prevent tampering. For more information, see: [Deserialization prevention] (https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html) We do not recommend deserializing untrusted data with the `Kryo` unless you explicitly define permissions for types that are allowed to be deserialized by `Kryo`.'
    severity: ERROR
    metadata:
      likelihood: MEDIUM
      impact: HIGH
      confidence: MEDIUM
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-502: Deserialization of Untrusted Data"
      cwe2020-top25: true
      cwe2021-top25: true
      cwe2022-top25: true
      display-name: Unsafe Deserialization in Kryo with Spring
      functional-categories:
        - deserialization::sink::load-object::kryo
        - web::source::cookie::Spring
        - web::source::header::Spring
        - web::source::http-body::Spring
        - web::source::url-path-params::Spring
        - web::source::url-query-string::Spring
      owasp:
        - A08:2017 - Insecure Deserialization
        - A08:2021 - Software and Data Integrity Failures
        - A08:2025 - Software or Data Integrity Failures
      references:
        - https://github.com/EsotericSoftware/kryo
        - https://owasp.org/Top10/2025/A08_2025-Software_or_Data_Integrity_Failures/
        - https://owasp.org/Top10/A08_2021-Software_and_Data_Integrity_Failures
      supersedes:
        - java.kryo.audit.kryo-deserialization-deepsemgrep.kryo-deserialization-deepsemgrep
        - java.servlets.security.kryo-deserialization-deepsemgrep.kryo-deserialization-deepsemgrep
      technology:
        - Spring
        - java
        - kryo
        - xml
      license: Semgrep Rules License v1.0. For more details, visit semgrep.dev/legal/rules-license
      vulnerability_class:
        - 'Insecure Deserialization '
    languages:
      - java
    mode: taint
    options:
      interfile: true
      taint_assume_safe_booleans: true
      taint_assume_safe_numbers: true
    pattern-sources:
      - label: REQ
        patterns:
          - pattern-either:
              - pattern: $RET $METHOD(..., @$REQ(...) $TYPE $SOURCE, ...) {...}
              - pattern: $RET $METHOD(..., @$REQ $TYPE $SOURCE, ...) {...}
          - metavariable-regex:
              metavariable: $REQ
              regex: (RequestBody|PathVariable|RequestParam|RequestHeader|CookieValue|ModelAttribute|MatrixVariable|RequestPart|RequestAttribute)
          - focus-metavariable: $SOURCE
      - label: REQ
        patterns:
          - pattern-either:
              - pattern-inside: |
                  @$MAPPING(...)
                  $RET $METHODNAME(..., $TYPE $SOURCE, ...) {...}
              - pattern-inside: |
                  @$MAPPING
                  $RET $METHODNAME(..., $TYPE $SOURCE, ...) {...}
          - pattern-either:
              - pattern: $RET $METHOD(..., String $SOURCE, ...) {...}
              - pattern: $RET $METHOD(..., org.springframework.http.HttpEntity<$X> $SOURCE, ...) {...}
              - pattern: $RET $METHOD(..., java.io.InputStream $SOURCE, ...) {...}
              - pattern: $RET $METHOD(..., java.io.Reader $SOURCE, ...) {...}
          - metavariable-regex:
              metavariable: $MAPPING
              regex: (ResponseBody|RequestMapping|PatchMapping|GetMapping|DeleteMapping|PutMapping|PostMapping|HttpExchange|GetExchange|PostExchange|PutExchange|PatchExchange|DeleteExchange|ResponseStatus)
          - focus-metavariable: $SOURCE
      - label: REQ
        patterns:
          - pattern-either:
              - pattern: (org.springframework.web.context.request.WebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.NativeWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.FacesWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.ServletWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.servlet.handler.DispatcherServletWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.async.AsyncWebRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.context.request.async.StandardServletAsyncWebRequest $REQ).$METHOD(...)
          - metavariable-regex:
              metavariable: $METHOD
              regex: (getHeader|getHeaderNames|getHeaderValues|getParameter|getParameterMap|getParameterNames|getParameterValues|getAttribute|getAttributeNames)
      - label: REQ
        patterns:
          - pattern-either:
              - pattern: (org.springframework.http.HttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.client.ClientHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.server.ServerHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.server.ServletServerHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.web.multipart.support.RequestPartServletServerHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.server.reactive.ServerHttpRequest $REQ).$METHOD(...)
              - pattern: (org.springframework.http.server.reactive.ServerHttpRequestDecorator $REQ).$METHOD(...)
          - metavariable-regex:
              metavariable: $METHOD
              regex: (getPath|getQueryParams|getBody|getURI|getHeaders|getCookies)
      - by-side-effect: true
        label: REG_FALSE
        patterns:
          - focus-metavariable: $K
          - pattern-either:
              - pattern: (Kryo $K).setRegistrationRequired(false)
    pattern-propagators:
      - from: $FROM
        patterns:
          - pattern-either:
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add($FROM)
                      - pattern: $TO.add($X, $FROM)
                      - pattern: $TO.addAll($FROM)
                      - pattern: $TO.addAll($X, $FROM)
                      - pattern: $TO.addFirst(..., $FROM, ...)
                      - pattern: $TO.addLast(..., $FROM, ...)
                      - pattern: $TO.addAllAbsent(..., $FROM, ...)
                      - pattern: $TO.addIfAbsent(..., $FROM, ...)
                      - pattern: $TO.addElement(..., $FROM, ...)
                      - pattern: $TO.set($X, $FROM)
                      - pattern: $TO.push(..., $FROM, ...)
                      - pattern: $TO.setElementAt(..., $FROM, ...)
                      - pattern: $TO.replaceAll(..., $FROM, ...)
                      - pattern: $TO.insertElementAt($FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.List
                        - java.util.List<$_>
                        - java.util.Stack
                        - java.util.Stack<$_>
                        - java.util.Vector
                        - java.util.Vector<$_>
                        - java.util.ArrayList
                        - java.util.ArrayList<$_>
                        - java.util.LinkedList
                        - java.util.LinkedList<$_>
                        - java.util.AbstractList
                        - java.util.AbstractList<$_>
                        - java.util.AbstractSequentialList
                        - java.util.AbstractSequentialList<$_>
                        - java.util.concurrent.CopyOnWriteArrayList
                        - java.util.concurrent.CopyOnWriteArrayList<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add(..., $FROM, ...)
                      - pattern: $TO.addFirst(..., $FROM, ...)
                      - pattern: $TO.addLast(..., $FROM, ...)
                      - pattern: $TO.addAll(..., $FROM, ...)
                      - pattern: $TO.put(..., $FROM, ...)
                      - pattern: $TO.putLast(..., $FROM, ...)
                      - pattern: $TO.putFirst(..., $FROM, ...)
                      - pattern: $TO.push(..., $FROM, ...)
                      - pattern: $TO.offer($FROM, ...)
                      - pattern: $TO.offerLast($FROM, ...)
                      - pattern: $TO.offerFirst($FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Queue
                        - java.util.Queue<$_>
                        - java.util.Deque
                        - java.util.Deque<$_>
                        - java.util.ArrayDeque
                        - java.util.ArrayDeque<$_>
                        - java.util.AbstractQueue
                        - java.util.AbstractQueue<$_>
                        - java.util.concurrent.DelayQueue
                        - java.util.concurrent.DelayQueue<$_>
                        - java.util.concurrent.BlockingQueue
                        - java.util.concurrent.BlockingQueue<$_>
                        - java.util.concurrent.TransferQueue
                        - java.util.concurrent.TransferQueue<$_>
                        - java.util.concurrent.BlockingDeque
                        - java.util.concurrent.BlockingDeque<$_>
                        - java.util.concurrent.SynchronousQueue
                        - java.util.concurrent.SynchronousQueue<$_>
                        - java.util.concurrent.LinkedTransferQueue
                        - java.util.concurrent.LinkedTransferQueue<$_>
                        - java.util.concurrent.ArrayBlockingQueue
                        - java.util.concurrent.ArrayBlockingQueue<$_>
                        - java.util.concurrent.LinkedBlockingDeque
                        - java.util.concurrent.LinkedBlockingDeque<$_>
                        - java.util.concurrent.LinkedBlockingQueue
                        - java.util.concurrent.LinkedBlockingQueue<$_>
                        - java.util.concurrent.PriorityBlockingQueue
                        - java.util.concurrent.PriorityBlockingQueue<$_>
                        - java.util.concurrent.ConcurrentLinkedDeque
                        - java.util.concurrent.ConcurrentLinkedDeque<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add(..., $FROM, ...)
                      - pattern: $TO.addAll(..., $FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Set
                        - java.util.Set<$_>
                        - java.util.TreeSet
                        - java.util.TreeSet<$_>
                        - java.util.EnumSet
                        - java.util.EnumSet<$_>
                        - java.util.HashSet
                        - java.util.HashSet<$_>
                        - java.util.SortedSet
                        - java.util.SortedSet<$_>
                        - java.util.AbstractSet
                        - java.util.AbstractSet<$_>
                        - java.util.NavigableSet
                        - java.util.NavigableSet<$_>
                        - java.util.LinkedHashSet
                        - java.util.LinkedHashSet<$_>
                        - java.util.AbstractCollection
                        - java.util.AbstractCollection<$_>
                        - java.util.concurrent.CopyOnWriteArraySet
                        - java.util.concurrent.CopyOnWriteArraySet<$_>
                        - java.util.concurrent.ConcurrentSkipListSet
                        - java.util.concurrent.ConcurrentSkipListSet<$_>
                        - java.util.concurrent.ConcurrentHashMap.KeySetView
                        - java.util.concurrent.ConcurrentHashMap.KeySetView<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.merge(..., $FROM, ...)
                      - pattern: $TO.put(..., $FROM, ...)
                      - pattern: $TO.putAll(..., $FROM, ...)
                      - pattern: $TO.putIfAbsent(..., $FROM, ...)
                      - pattern: $TO.replace($X, ..., $FROM, ...)
                      - pattern: $TO.replaceAll(..., $FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Map
                        - java.util.Map<$_, $_>
                        - java.util.NavigableMap
                        - java.util.NavigableMap<$_, $_>
                        - java.util.SortedMap
                        - java.util.SortedMap<$_, $_>
                        - java.util.TreeMap
                        - java.util.TreeMap<$_, $_>
                        - java.util.AbstractMap
                        - java.util.AbstractMap<$_, $_>
                        - java.util.EnumMap
                        - java.util.EnumMap<$_, $_>
                        - java.util.HashMap
                        - java.util.HashMap<$_, $_>
                        - java.util.Hashtable
                        - java.util.Hashtable<$_, $_>
                        - java.util.IdentityHashMap
                        - java.util.IdentityHashMap<$_, $_>
                        - java.util.LinkedHashMap
                        - java.util.LinkedHashMap<$_, $_>
                        - java.util.WeakHashMap
                        - java.util.WeakHashMap<$_, $_>
                        - java.util.concurrent.ConcurrentMap
                        - java.util.concurrent.ConcurrentMap<$_, $_>
                        - java.util.concurrent.ConcurrentHashMap
                        - java.util.concurrent.ConcurrentHashMap<$_, $_>
                        - java.util.concurrent.ConcurrentSkipListMap
                        - java.util.concurrent.ConcurrentSkipListMap<$_, $_>
                        - java.util.concurrent.ConcurrentNavigableMap
                        - java.util.concurrent.ConcurrentNavigableMap<$_, $_>
                        - java.util.Properties
                        - java.util.Properties<$_, $_>
        to: $TO
      - from: $INPUT
        patterns:
          - pattern-either:
              - pattern: String.format($FMT, ..., $INPUT, ...)
              - pattern: MessageFormat.format($FMT, ..., $INPUT, ...)
        to: $FMT
      - from: $FROM
        patterns:
          - pattern-either:
              - pattern: (StringBuilder $TO).append($FROM, ...)
              - pattern: (StringBuilder $TO).insert($OFFSET, $FROM, ...)
              - pattern: (StringBuilder $TO).replace($START, $END, $FROM, ...)
              - pattern: (StringBuffer $TO).append($FROM, ...)
              - pattern: (StringBuffer $TO).insert($OFFSET, $FROM, ...)
        to: $TO
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: (Kryo $K).readObject(...)
              - pattern: (Kryo $K).readObjectOrNull(...)
        requires: REQ and REG_FALSE
      - patterns:
          - pattern-either:
              - pattern: (Kryo $K).readClassAndObject(...)
        requires: REQ
    pattern-sanitizers:
      - pattern: (ChoiceFormat $X).format(...)
      - pattern: (DecimalFormat $X).format(...)
      - pattern: (java.util.UUID $X)
