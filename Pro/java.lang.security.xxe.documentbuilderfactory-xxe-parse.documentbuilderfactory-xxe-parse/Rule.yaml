rules:
  - id: documentbuilderfactory-xxe-parse
    message: 'The application is using an XML parser that has not been safely configured. This might lead to XML External Entity (XXE) vulnerabilities when parsing user-controlled input. An attacker can include document type definitions (DTDs) or XIncludes which can interact with internal or external hosts. XXE can lead to other vulnerabilities, such as Local File Inclusion (LFI), Remote Code Execution (RCE), and Server-side request forgery (SSRF), depending on the application configuration. An attacker can also use DTDs to expand recursively, leading to a Denial-of-Service (DoS) attack, also known as a `Billion Laughs Attack`. It is our recommendation to secure this parser against XXE attacks by configuring $FACTORY with `$FACTORY.setFeature(http://apache.org/xml/features/disallow-doctype-decl, true)`. Alternatively, the following configurations also provide protection against XXE attacks. `$FACTORY.setExpandEntityReferences(false)` `$FACTORY.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true)` `$FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "")` `$FACTORY.setFeature("http://xml.org/sax/features/external-general-entities", false)`. For more information, see: [Java XXE prevention](https://semgrep.dev/docs/cheat-sheets/java-xxe/)'
    severity: ERROR
    metadata:
      likelihood: MEDIUM
      impact: HIGH
      confidence: HIGH
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-611: Improper Restriction of XML External Entity Reference"
      cwe2020-top25: true
      cwe2021-top25: true
      cwe2022-top25: true
      display-name: XML External Entity (XXE) in DocumentBuilderFactory
      functional-categories:
        - xml::sink::xml-parser::javax.xml
      owasp:
        - A02:2025 - Security Misconfiguration
        - A04:2017 - XML External Entities (XXE)
        - A05:2021 - Security Misconfiguration
      references:
        - https://blog.sonarsource.com/secure-xml-processor/
        - https://blog.sonarsource.com/understanding-xxe-vulnerabilities/
        - https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html
        - https://cwe.mitre.org/data/definitions/611.html
        - https://cwe.mitre.org/data/definitions/776.html
        - https://docs.oracle.com/en/java/javase/13/security/java-api-xml-processing-jaxp-security-guide.html#GUID-D97A1F1D-8DDF-4D19-A7E5-99099F27346E
        - https://github.com/semgrep/java-xxe-research
        - https://owasp.org/Top10/2025/A02_2025-Security_Misconfiguration/
        - https://owasp.org/Top10/A05_2021-Security_Misconfiguration
        - https://rules.sonarsource.com/java/type/Vulnerability/RSPEC-2755
      supersedes:
        - java.lang.security.audit.xxe.documentbuilderfactory-disallow-doctype-decl-false.documentbuilderfactory-disallow-doctype-decl-false
        - java.lang.security.audit.xxe.documentbuilderfactory-disallow-doctype-decl-missing.documentbuilderfactory-disallow-doctype-decl-missing
        - java.lang.security.audit.xxe.documentbuilderfactory-external-general-entities-true.documentbuilderfactory-external-general-entities-true
        - java.lang.security.audit.xxe.documentbuilderfactory-external-parameter-entities-true.documentbuilderfactory-external-parameter-entities-true
        - java.lang.security.xxe.documentbuilderfactory-xxe.documentbuilderfactory-xxe
      technology:
        - xml
      license: Semgrep Rules License v1.0. For more details, visit semgrep.dev/legal/rules-license
      vulnerability_class:
        - XML Injection
    languages:
      - java
    mode: taint
    options:
      interfile: true
      taint_assume_safe_booleans: true
      taint_assume_safe_numbers: true
      taint_match_on: source
    pattern-sources:
      - patterns:
          - pattern: $FACTORY = javax.xml.parsers.DocumentBuilderFactory.newInstance()
          - pattern-inside: |
              $FACTORY = ...;
              ...
              $PARSER = $FACTORY.newDocumentBuilder();
          - pattern-not-inside: |
              $FACTORY = ...;
              ...
              $FACTORY.setFeature("=~/.*secure-processing.*/", true);
          - pattern-not-inside: |
              $FACTORY = ...;
              ...
              $FACTORY.setAttribute("=~/.*accessExternalDTD.*/", "");
          - pattern-not-inside: |
              $FACTORY = ...;
              ...
              $FACTORY.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
          - pattern-not-inside: |
              $FACTORY = ...;
              ...
              $FACTORY.setExpandEntityReferences(false);
          - pattern-not-inside: |
              $FACTORY = ...;
              ...
              $FACTORY.setFeature(javax.xml.XMLConstants.FEATURE_SECURE_PROCESSING, true);
          - pattern-not-inside: |
              $FACTORY = ...;
              ...
              $FACTORY.setAttribute(javax.xml.XMLConstants.ACCESS_EXTERNAL_DTD, "");
          - pattern-not-inside: |
              $FACTORY = ...;
              ...
              $FACTORY.setFeature("http://xml.org/sax/features/external-general-entities", false);
          - pattern-not-inside: |
              $FACTORY = ...;
              ...
              $PARSER = $FACTORY.newDocumentBuilder();
              ...
              $PARSER.setEntityResolver(...);
    pattern-propagators:
      - from: $FROM
        patterns:
          - pattern-either:
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add($FROM)
                      - pattern: $TO.add($X, $FROM)
                      - pattern: $TO.addAll($FROM)
                      - pattern: $TO.addAll($X, $FROM)
                      - pattern: $TO.addFirst(..., $FROM, ...)
                      - pattern: $TO.addLast(..., $FROM, ...)
                      - pattern: $TO.addAllAbsent(..., $FROM, ...)
                      - pattern: $TO.addIfAbsent(..., $FROM, ...)
                      - pattern: $TO.addElement(..., $FROM, ...)
                      - pattern: $TO.set($X, $FROM)
                      - pattern: $TO.push(..., $FROM, ...)
                      - pattern: $TO.setElementAt(..., $FROM, ...)
                      - pattern: $TO.replaceAll(..., $FROM, ...)
                      - pattern: $TO.insertElementAt($FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.List
                        - java.util.List<$_>
                        - java.util.Stack
                        - java.util.Stack<$_>
                        - java.util.Vector
                        - java.util.Vector<$_>
                        - java.util.ArrayList
                        - java.util.ArrayList<$_>
                        - java.util.LinkedList
                        - java.util.LinkedList<$_>
                        - java.util.AbstractList
                        - java.util.AbstractList<$_>
                        - java.util.AbstractSequentialList
                        - java.util.AbstractSequentialList<$_>
                        - java.util.concurrent.CopyOnWriteArrayList
                        - java.util.concurrent.CopyOnWriteArrayList<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add(..., $FROM, ...)
                      - pattern: $TO.addFirst(..., $FROM, ...)
                      - pattern: $TO.addLast(..., $FROM, ...)
                      - pattern: $TO.addAll(..., $FROM, ...)
                      - pattern: $TO.put(..., $FROM, ...)
                      - pattern: $TO.putLast(..., $FROM, ...)
                      - pattern: $TO.putFirst(..., $FROM, ...)
                      - pattern: $TO.push(..., $FROM, ...)
                      - pattern: $TO.offer($FROM, ...)
                      - pattern: $TO.offerLast($FROM, ...)
                      - pattern: $TO.offerFirst($FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Queue
                        - java.util.Queue<$_>
                        - java.util.Deque
                        - java.util.Deque<$_>
                        - java.util.ArrayDeque
                        - java.util.ArrayDeque<$_>
                        - java.util.AbstractQueue
                        - java.util.AbstractQueue<$_>
                        - java.util.concurrent.DelayQueue
                        - java.util.concurrent.DelayQueue<$_>
                        - java.util.concurrent.BlockingQueue
                        - java.util.concurrent.BlockingQueue<$_>
                        - java.util.concurrent.TransferQueue
                        - java.util.concurrent.TransferQueue<$_>
                        - java.util.concurrent.BlockingDeque
                        - java.util.concurrent.BlockingDeque<$_>
                        - java.util.concurrent.SynchronousQueue
                        - java.util.concurrent.SynchronousQueue<$_>
                        - java.util.concurrent.LinkedTransferQueue
                        - java.util.concurrent.LinkedTransferQueue<$_>
                        - java.util.concurrent.ArrayBlockingQueue
                        - java.util.concurrent.ArrayBlockingQueue<$_>
                        - java.util.concurrent.LinkedBlockingDeque
                        - java.util.concurrent.LinkedBlockingDeque<$_>
                        - java.util.concurrent.LinkedBlockingQueue
                        - java.util.concurrent.LinkedBlockingQueue<$_>
                        - java.util.concurrent.PriorityBlockingQueue
                        - java.util.concurrent.PriorityBlockingQueue<$_>
                        - java.util.concurrent.ConcurrentLinkedDeque
                        - java.util.concurrent.ConcurrentLinkedDeque<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.add(..., $FROM, ...)
                      - pattern: $TO.addAll(..., $FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Set
                        - java.util.Set<$_>
                        - java.util.TreeSet
                        - java.util.TreeSet<$_>
                        - java.util.EnumSet
                        - java.util.EnumSet<$_>
                        - java.util.HashSet
                        - java.util.HashSet<$_>
                        - java.util.SortedSet
                        - java.util.SortedSet<$_>
                        - java.util.AbstractSet
                        - java.util.AbstractSet<$_>
                        - java.util.NavigableSet
                        - java.util.NavigableSet<$_>
                        - java.util.LinkedHashSet
                        - java.util.LinkedHashSet<$_>
                        - java.util.AbstractCollection
                        - java.util.AbstractCollection<$_>
                        - java.util.concurrent.CopyOnWriteArraySet
                        - java.util.concurrent.CopyOnWriteArraySet<$_>
                        - java.util.concurrent.ConcurrentSkipListSet
                        - java.util.concurrent.ConcurrentSkipListSet<$_>
                        - java.util.concurrent.ConcurrentHashMap.KeySetView
                        - java.util.concurrent.ConcurrentHashMap.KeySetView<$_>
              - patterns:
                  - pattern-either:
                      - pattern: $TO.merge(..., $FROM, ...)
                      - pattern: $TO.put(..., $FROM, ...)
                      - pattern: $TO.putAll(..., $FROM, ...)
                      - pattern: $TO.putIfAbsent(..., $FROM, ...)
                      - pattern: $TO.replace($X, ..., $FROM, ...)
                      - pattern: $TO.replaceAll(..., $FROM, ...)
                  - metavariable-type:
                      metavariable: $TO
                      types:
                        - java.util.Map
                        - java.util.Map<$_, $_>
                        - java.util.NavigableMap
                        - java.util.NavigableMap<$_, $_>
                        - java.util.SortedMap
                        - java.util.SortedMap<$_, $_>
                        - java.util.TreeMap
                        - java.util.TreeMap<$_, $_>
                        - java.util.AbstractMap
                        - java.util.AbstractMap<$_, $_>
                        - java.util.EnumMap
                        - java.util.EnumMap<$_, $_>
                        - java.util.HashMap
                        - java.util.HashMap<$_, $_>
                        - java.util.Hashtable
                        - java.util.Hashtable<$_, $_>
                        - java.util.IdentityHashMap
                        - java.util.IdentityHashMap<$_, $_>
                        - java.util.LinkedHashMap
                        - java.util.LinkedHashMap<$_, $_>
                        - java.util.WeakHashMap
                        - java.util.WeakHashMap<$_, $_>
                        - java.util.concurrent.ConcurrentMap
                        - java.util.concurrent.ConcurrentMap<$_, $_>
                        - java.util.concurrent.ConcurrentHashMap
                        - java.util.concurrent.ConcurrentHashMap<$_, $_>
                        - java.util.concurrent.ConcurrentSkipListMap
                        - java.util.concurrent.ConcurrentSkipListMap<$_, $_>
                        - java.util.concurrent.ConcurrentNavigableMap
                        - java.util.concurrent.ConcurrentNavigableMap<$_, $_>
                        - java.util.Properties
                        - java.util.Properties<$_, $_>
        to: $TO
      - from: $INPUT
        patterns:
          - pattern-either:
              - pattern: String.format($FMT, ..., $INPUT, ...)
              - pattern: MessageFormat.format($FMT, ..., $INPUT, ...)
        to: $FMT
      - from: $FROM
        patterns:
          - pattern-either:
              - pattern: (StringBuilder $TO).append($FROM, ...)
              - pattern: (StringBuilder $TO).insert($OFFSET, $FROM, ...)
              - pattern: (StringBuilder $TO).replace($START, $END, $FROM, ...)
              - pattern: (StringBuffer $TO).append($FROM, ...)
              - pattern: (StringBuffer $TO).insert($OFFSET, $FROM, ...)
        to: $TO
      - from: $FACTORY
        patterns:
          - pattern: $PARSER = $FACTORY.newDocumentBuilder()
        to: $PARSER
    pattern-sinks:
      - pattern: (DocumentBuilder $PARSER).parse(...)
    pattern-sanitizers:
      - pattern: (ChoiceFormat $X).format(...)
      - pattern: (DecimalFormat $X).format(...)
      - pattern: (java.util.UUID $X)
