package com.example.owasp.a03;

import java.sql.*;

/**
 * A03:2021 – Injection
 * 漏洞演示：SQL 注入攻击
 */
public class InjectionVulnerability {
    
    /**
     * 漏洞代码：使用字符串拼接构建 SQL 查询
     * 攻击示例：username = "admin' OR '1'='1"
     */
    public static User getUserByNameVulnerable(String username, Connection conn) throws SQLException {
        String query = "SELECT * FROM users WHERE username = '" + username + "'";
        
        Statement stmt = conn.createStatement();
        ResultSet rs = stmt.executeQuery(query);
        
        if (rs.next()) {
            return new User(rs.getInt("id"), rs.getString("username"), rs.getString("email"));
        }
        return null;
    }
    
    /**
     * 漏洞代码：命令注入 - 直接执行用户输入
     */
    public static void executeCommandVulnerable(String userInput) throws Exception {
        // 危险：直接执行用户提供的命令
        String cmd = "ls -la " + userInput;
        Runtime.getRuntime().exec(cmd);
    }
    
    /**
     * 改进版本：使用预处理语句（PreparedStatement）防止 SQL 注入
     */
    public static User getUserByNameSecure(String username, Connection conn) throws SQLException {
        String query = "SELECT * FROM users WHERE username = ?";
        
        PreparedStatement pstmt = conn.prepareStatement(query);
        pstmt.setString(1, username);
        
        ResultSet rs = pstmt.executeQuery();
        
        if (rs.next()) {
            return new User(rs.getInt("id"), rs.getString("username"), rs.getString("email"));
        }
        return null;
    }
    
    /**
     * 改进版本：使用允许列表验证输入和 ProcessBuilder
     * 防止命令注入的最佳实践
     */
    public static void executeCommandSecure(String userInput) throws Exception {
        // 步骤1：验证输入是否在允许列表中
        String[] allowedDirs = {"/home/user/data", "/tmp", "/var/log"};
        
        boolean isAllowed = false;
        for (String dir : allowedDirs) {
            if (userInput.equals(dir)) {
                isAllowed = true;
                break;
            }
        }
        
        if (!isAllowed) {
            throw new IllegalArgumentException("Invalid directory");
        }
        
        // 步骤2：使用 ProcessBuilder 代替 Runtime.exec()
        // 避免 shell 解析特殊字符（;、|、&、> 等）
        ProcessBuilder pb = new ProcessBuilder("ls", "-la", userInput);
        
        // 步骤3：设置工作目录（可选但推荐）
        pb.directory(new java.io.File("/home/user"));
        
        // 步骤4：执行命令
        Process process = pb.start();
        
        // 步骤5：等待命令完成
        int exitCode = process.waitFor();
        System.out.println("Command completed with exit code: " + exitCode);
    }
    
    static class User {
        int id;
        String username;
        String email;
        
        User(int id, String username, String email) {
            this.id = id;
            this.username = username;
            this.email = email;
        }
    }
    
    public static void main(String[] args) {
        System.out.println("=== SQL Injection Demo ===");
        System.out.println("Vulnerable Query: SELECT * FROM users WHERE username = 'admin' OR '1'='1'");
        System.out.println("Result: Returns all users instead of just admin");
        
        System.out.println("\n=== Command Injection Demo ===");
        System.out.println("Vulnerable: ls -la --help; rm -rf /");
        System.out.println("Result: Arbitrary command execution");
        
        System.out.println("\n=== Secure Approach ===");
        System.out.println("Use PreparedStatement and Input Validation");
    }
}
