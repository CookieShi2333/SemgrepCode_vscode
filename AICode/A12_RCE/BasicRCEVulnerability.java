package com.example.owasp.a12;

import java.io.IOException;

/**
 * A12: 远程代码执行 (RCE) 漏洞
 * 
 * 这个类演示基础的 RCE 漏洞，其中用户输入直接传递给
 * shell/系统命令，没有进行适当的验证。
 */
public class BasicRCEVulnerability {

    /**
     * 漏洞: 用户输入直接传递给 Runtime.exec()
     * 
     * 攻击者可以注入任意命令:
     * 输入: "test.txt; rm -rf /" 
     * 结果: 两个命令都会被执行
     */
    public static String executeSystemCommand(String filename) throws IOException {
        // 漏洞: 用户输入直接参与命令拼接
        String command = "cat " + filename;
        Process process = Runtime.getRuntime().exec(command);
        
        java.io.BufferedReader reader = new java.io.BufferedReader(
            new java.io.InputStreamReader(process.getInputStream())
        );
        StringBuilder output = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
            output.append(line).append("\n");
        }
        return output.toString();
    }

    /**
     * 漏洞: 命令通过字符串拼接构造
     */
    public static void listFiles(String directory) throws IOException {
        // 漏洞: 没有验证目录参数
        String command = "ls -la " + directory;
        Runtime.getRuntime().exec(command);
    }

    /**
     * 安全: 使用 ProcessBuilder 的数组形式传递命令和参数
     * 这样可以防止 shell 元字符解释
     */
    public static String executeSystemCommandSecure(String filename) throws IOException {
        // 安全: 使用 ProcessBuilder 传递分离的参数
        ProcessBuilder pb = new ProcessBuilder("cat", filename);
        Process process = pb.start();
        
        java.io.BufferedReader reader = new java.io.BufferedReader(
            new java.io.InputStreamReader(process.getInputStream())
        );
        StringBuilder output = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
            output.append(line).append("\n");
        }
        return output.toString();
    }

    /**
     * 安全: 验证和白名单允许的命令
     */
    public static void listFilesSecure(String directory) throws IOException {
        // 安全: 验证输入是否为有效路径
        java.nio.file.Path path = java.nio.file.Paths.get(directory);
        if (!path.toFile().isDirectory()) {
            throw new IllegalArgumentException("目录无效");
        }
        
        // 使用 ProcessBuilder 传递分离的参数
        ProcessBuilder pb = new ProcessBuilder("ls", "-la", directory);
        pb.start();
    }

    public static void main(String[] args) {
        try {
            // Example usage
            String result = executeSystemCommand("/etc/passwd");
            System.out.println(result);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
