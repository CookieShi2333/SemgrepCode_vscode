package com.example.owasp.a10.ssrf;

import java.io.InputStream;
import java.net.URL;
import java.net.URLConnection;

/**
 * A10:2021 – Server-Side Request Forgery (SSRF)
 * 漏洞示例1：基础的 SSRF 漏洞 - 直接获取用户提供的 URL
 */
public class BasicSSRFVulnerability {
    
    /**
     * 漏洞代码：直接使用用户输入的 URL
     * 攻击示例：
     * 1. http://localhost:6379/  - 访问 Redis
     * 2. http://169.254.169.254/latest/meta-data/  - AWS 元数据
     * 3. http://192.168.1.1:8080/admin/  - 内部管理面板
     */
    public static String fetchUrlVulnerable(String userUrl) {
        try {
            URL url = new URL(userUrl);
            URLConnection connection = url.openConnection();
            connection.setConnectTimeout(5000);
            
            InputStream is = connection.getInputStream();
            StringBuilder response = new StringBuilder();
            int character;
            
            while ((character = is.read()) != -1) {
                response.append((char) character);
                // 限制响应大小以防止过大数据
                if (response.length() > 10000) {
                    break;
                }
            }
            
            return response.toString();
        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
    
    /**
     * 改进版本1：使用 URL 白名单
     */
    public static String fetchUrlWithWhitelist(String userUrl) {
        // 定义允许的域名白名单
        String[] allowedHosts = {
                "api.example.com",
                "api.github.com",
                "api.twitter.com",
                "cdn.example.com"
        };
        
        try {
            URL url = new URL(userUrl);
            String host = url.getHost();
            
            // 检查主机是否在白名单中
            boolean isAllowed = false;
            for (String allowed : allowedHosts) {
                if (host.equalsIgnoreCase(allowed)) {
                    isAllowed = true;
                    break;
                }
            }
            
            if (!isAllowed) {
                throw new SecurityException("Host not in whitelist: " + host);
            }
            
            // 检查协议
            if (!url.getProtocol().matches("https?")) {
                throw new SecurityException("Invalid protocol: " + url.getProtocol());
            }
            
            // 检查端口
            int port = url.getPort();
            if (port != -1 && port != 80 && port != 443) {
                throw new SecurityException("Invalid port: " + port);
            }
            
            URLConnection connection = url.openConnection();
            connection.setConnectTimeout(5000);
            InputStream is = connection.getInputStream();
            
            StringBuilder response = new StringBuilder();
            int character;
            while ((character = is.read()) != -1) {
                response.append((char) character);
                if (response.length() > 10000) break;
            }
            
            return response.toString();
            
        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
    
    /**
     * 改进版本2：阻止访问私有 IP 地址
     */
    public static String fetchUrlBlockPrivateIps(String userUrl) {
        try {
            URL url = new URL(userUrl);
            String host = url.getHost();
            
            // 识别及阻止私有 IP 地址
            if (isPrivateOrReservedIp(host)) {
                throw new SecurityException("Access to private/reserved IP denied: " + host);
            }
            
            URLConnection connection = url.openConnection();
            connection.setConnectTimeout(5000);
            InputStream is = connection.getInputStream();
            
            StringBuilder response = new StringBuilder();
            int character;
            while ((character = is.read()) != -1) {
                response.append((char) character);
                if (response.length() > 5000) break;
            }
            
            return response.toString();
            
        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
    
    /**
     * 检查是否为私有或保留 IP 地址
     */
    private static boolean isPrivateOrReservedIp(String host) {
        if (host.equals("localhost") || host.equals("127.0.0.1")) {
            return true;
        }
        
        // IPv4 私有地址范围
        if (host.startsWith("192.168.") ||    // 192.168.0.0/16
            host.startsWith("10.") ||          // 10.0.0.0/8
            host.startsWith("172.")) {         // 172.16.0.0/12
            return true;
        }
        
        // AWS 元数据服务
        if (host.equals("169.254.169.254")) {
            return true;
        }
        
        // IPv6 环回地址
        if (host.equals("::1")) {
            return true;
        }
        
        return false;
    }
    
    /**
     * 改进版本3：使用代理服务来隔离 SSRF 风险
     */
    public static String fetchUrlViaProxy(String userUrl) {
        try {
            // 所有请求都通过代理服务进行验证和转发
            String proxyService = "https://trusted-proxy.example.com/fetch";
            
            // 使用参数而不是直接 URL
            java.net.http.HttpClient client = java.net.http.HttpClient.newHttpClient();
            java.net.http.HttpRequest request = java.net.http.HttpRequest.newBuilder()
                    .uri(new URL(proxyService + "?target=" + java.net.URLEncoder.encode(userUrl, "UTF-8")).toURI())
                    .GET()
                    .build();
            
            java.net.http.HttpResponse<String> response = client.send(request, 
                    java.net.http.HttpResponse.BodyHandlers.ofString());
            
            return response.body();
            
        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
    
    public static void main(String[] args) {
        System.out.println("=== SSRF Vulnerability Demo ===\n");
        
        System.out.println("=== Vulnerable Code ===");
        System.out.println("1. Direct URL: http://localhost:6379/");
        System.out.println("   Result: Access Redis on internal network\n");
        
        System.out.println("2. AWS Metadata: http://169.254.169.254/latest/meta-data/");
        System.out.println("   Result: Leak AWS credentials\n");
        
        System.out.println("3. Internal Admin: http://192.168.1.1:8080/admin/");
        System.out.println("   Result: Bypass authentication\n");
        
        System.out.println("=== Secure Approaches ===");
        System.out.println("1. Host whitelist validation");
        System.out.println("2. Block private/reserved IP addresses");
        System.out.println("3. Restrict ports (only 80, 443)");
        System.out.println("4. Use proxy service for isolation");
        System.out.println("5. Disable unnecessary URL schemes");
    }
}
